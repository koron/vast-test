<html>
<head>
<title>Ad Player</title>
<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
<style type="text/css">
#mainContainer {
  position: relative;
  width: 640px;
  height: 360px;
}
#content {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 640px;
  height: 360px;
}
#mediaElement {
  width: 640px;
  height: 360px;
}
</style>
<script type="text/javascript">
(function(w){

const events = [
  [0.25, function() {
    console.log('video.timeupdate: 25%')
  }],
  [0.50, function() {
    console.log('video.timeupdate: 50%')
  }],
  [0.75, function() {
    console.log('video.timeupdate: 75%')
  }],
  [1.0, function() {
    console.log('video.timeupdate: 100%')
  }],
]

w.onload = function(ev) {
  const d = w.document

  const me = d.getElementById('mediaElement')
  const mr = d.getElementById('muteRequest')
  const pr = d.getElementById('pauseRequest')
  const vi = d.getElementById('visibleIndicator')

  let visible = false
  function updatePlayPause() {
    if (me.ended) {
      return
    }
    if (!pr.checked && visible) {
      me.play()
    } else {
      me.pause()
    }
  }

  me.addEventListener('click', function() {
    console.log('video.click:', 'TODO: ClickThrough')
    if (!me.paused) {
      console.log('video.click:', 'force paused')
      pr.checked = true
      updatePlayPause()
    }
  })
  me.addEventListener('timeupdate', function() {
    let frac = me.currentTime / me.duration
    while (events.length > 0 && frac >= events[0][0]) {
      events.shift()[1]()
    }
  })
  mr.addEventListener('change', function() {
    me.muted = mr.checked
    if (me.muted) {
      console.log('mute.change: muted')
    } else {
      console.log('mute.change: unmuted')
    }
  })
  pr.addEventListener('change', function() {
    if (pr.checked) {
      console.log('pause.change: paused')
    } else {
      console.log('pause.change: unpaused')
    }
    updatePlayPause()
  })

  new IntersectionObserver(function(entries, observer) {
    if (entries.length == 0) {
      return
    }
    visible = entries[0].intersectionRatio >= 0.5
    if (vi) {
      vi.checked = visible
    }
    updatePlayPause()
  }, { "threshold": 0.5 }).observe(me)
}
})(window)
</script>
</head>
  <body>
    <a href="https://github.com/koron/vast-test"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
    <div style="height: 100vh"></div>
    <div id="mainContainer">
      <div id="content">
        <video id="mediaElement" muted>
          <source src="https://koron.github.io/vast-test/vast/pixabay-7515.mp4" type="video/mp4">
        </video>
      </div>
    </div>

    <!-- #muteRequest checkbox, MANDATORY -->
    <label for="muteRequest">Mute</label><input type="checkbox" id="muteRequest" checked>

    <!-- #pauseRequest checkbox, MANDATORY -->
    <label for="pauseRequest">Pause</label><input type="checkbox" id="pauseRequest">

    <!-- #visibleIndicator checkbox, OPTIONAL: indicates over 50% visibility of video element -->
    <label for="visibleIndicator">Visible 50%</label><input type="checkbox" id="visibleIndicator" disabled>

    <ul>
      <li><a href="../">Regular version</a>
      <li><a href="../modified.html">Modified version: hide "Learn More" link</a>
      <li><a href="../rev3">Revision #3</a>
      <li><a href=".">Revision #4 (this)</a>
    </ul>
    <div style="height: 100vh"></div>
  </body>
</html>
